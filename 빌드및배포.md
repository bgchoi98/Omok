# Omok_Mini 빌드 및 배포 가이드

## 프로젝트 구조

```
Omok_Mini/
├── scripts/
│   ├── build.sh              # 빌드 스크립트 (Java 8 컴파일)
│   └── install-libs.sh       # 라이브러리 설치 스크립트
├── src/
│   └── main/
│       ├── java/             # Java 소스 코드
│       └── webapp/           # 웹 루트 (Tomcat이 읽는 디렉토리)
│           └── WEB-INF/
│               ├── classes/  # 컴파일된 .class 파일 (빌드 산출물)
│               ├── lib/      # jar 의존성 (gson, mariadb 등)
│               ├── views/    # JSP 파일 (직접 접근 불가)
│               └── web.xml   # 웹 애플리케이션 설정
└── .vscode/
    └── tasks.json            # VSCode 빌드 태스크 설정
```

## 환경 요구사항

- Java 8 이상
- Apache Tomcat 9
- Tomcat 경로: `~/tomcat9`
- 프로젝트 경로: `~/workspace/test-dev/Omok_Mini`

---

## 1. 빌드하기

### 1-1. 명령줄에서 빌드

```bash
cd ~/workspace/test-dev/Omok_Mini
./scripts/build.sh
```

**빌드 스크립트가 하는 일:**

- `src/main/java` 아래 모든 `.java` 파일을 컴파일
- `javac --release 8 -encoding UTF-8` 사용
- Classpath에 포함:
  - `~/tomcat9/lib/servlet-api.jar`
  - `~/tomcat9/lib/websocket-api.jar`
  - `src/main/webapp/WEB-INF/lib/*.jar` (gson, mariadb 등)
- 산출물 위치: `src/main/webapp/WEB-INF/classes/`

### 1-2. VSCode에서 빌드

**방법 1: 단축키**

- `Ctrl+Shift+B` (또는 `Cmd+Shift+B`)

**방법 2: 커맨드 팔레트**

- `Ctrl+Shift+P` → "Tasks: Run Build Task" 선택

---

## 2. Tomcat 배포하기

### 2-1. 심링크 배포 (권장)

```bash
# 기존 배포 제거
rm -rf ~/tomcat9/webapps/Omok_Mini

# 심링크 생성
ln -s ~/workspace/test-dev/Omok_Mini/src/main/webapp ~/tomcat9/webapps/Omok_Mini

# Tomcat 캐시 삭제
rm -rf ~/tomcat9/work/Catalina/localhost/Omok_Mini
```

**장점:**

- 코드 수정 후 빌드만 하면 즉시 반영 (재배포 불필요)
- JSP 파일은 빌드 없이 수정만으로 반영됨

---

## 3. Tomcat 실행하기

### 3-1. 시작

```bash
~/tomcat9/bin/startup.sh
```

### 3-2. 종료

```bash
~/tomcat9/bin/shutdown.sh
```

### 3-3. 재시작

```bash
~/tomcat9/bin/shutdown.sh || true
sleep 2
~/tomcat9/bin/startup.sh
```

### 3-4. 로그 확인

```bash
tail -f ~/tomcat9/logs/catalina.out
```

---

## 4. 전체 빌드/배포/실행 루틴

**처음 배포 시 (한 번만):**

```bash
# 1. 빌드 스크립트 실행 권한 부여
chmod +x ~/workspace/test-dev/Omok_Mini/scripts/build.sh

# 2. 프로젝트로 이동
cd ~/workspace/test-dev/Omok_Mini

# 3. 빌드
./scripts/build.sh

# 4. 심링크 배포
rm -rf ~/tomcat9/webapps/Omok_Mini
ln -s ~/workspace/test-dev/Omok_Mini/src/main/webapp ~/tomcat9/webapps/Omok_Mini

# 5. 캐시 삭제
rm -rf ~/tomcat9/work/Catalina/localhost/Omok_Mini

# 6. Tomcat 재시작
~/tomcat9/bin/shutdown.sh || true
sleep 2
~/tomcat9/bin/startup.sh

# 7. 로그 확인 (필요시)
tail -f ~/tomcat9/logs/catalina.out
```

**일상적인 코드 수정 후:**

```bash
cd ~/workspace/test-dev/Omok_Mini

# 1. 빌드
./scripts/build.sh

# 2. Tomcat 재시작
~/tomcat9/bin/shutdown.sh || true
sleep 2
~/tomcat9/bin/startup.sh
```

**JSP 파일만 수정한 경우:**

- 빌드 불필요
- Tomcat 재시작만 하면 됨 (또는 자동 반영될 수도 있음)

---

## 5. 접속 확인

### 5-1. 커맨드라인에서 확인

```bash
# 로그인 페이지 접근 테스트
curl -I http://localhost:8080/Omok_Mini/sign/signIn

# 200 OK 응답이 나오면 정상
```

### 5-2. 브라우저에서 접근

```
http://localhost:8080/Omok_Mini/sign/signIn
http://localhost:8080/Omok_Mini/sign/signUp
http://localhost:8080/Omok_Mini/lobby
```

**주의:** WEB-INF 아래 JSP는 직접 접근 불가 (보안상 정상)

- ❌ `http://localhost:8080/Omok_Mini/WEB-INF/views/sign/signIn.jsp`
- ✅ `http://localhost:8080/Omok_Mini/sign/signIn` (컨트롤러 매핑)

---

## 6. 트러블슈팅

### 6-1. 중복 클래스 충돌 에러

**증상:**

```
The servlets named [user.UserController] and [users.UserController]
are both mapped to the url-pattern [/sign]
```

**원인:** 오래된 컴파일 산출물이 남아있음

**해결:**

```bash
# 기존 클래스 파일 전체 삭제
rm -rf ~/workspace/test-dev/Omok_Mini/src/main/webapp/WEB-INF/classes/*

# 다시 빌드
cd ~/workspace/test-dev/Omok_Mini
./scripts/build.sh

# Tomcat 재시작
~/tomcat9/bin/shutdown.sh || true
sleep 2
~/tomcat9/bin/startup.sh
```

### 6-2. ZipException: zip file is empty

**원인:** Tomcat lib 디렉토리의 jar 파일이 손상됨 (0바이트)

**진단:**

```bash
# 0바이트 jar 파일 찾기
find ~/tomcat9/lib -maxdepth 1 -name "*.jar" -size 0 -print
```

**해결:**

```bash
# 해당 jar 파일 제거 후 Tomcat 재설치 또는 jar 재다운로드
# 예: servlet-api.jar가 0바이트인 경우
rm ~/tomcat9/lib/servlet-api.jar

# Tomcat 재설치 또는 공식 사이트에서 해당 jar 다운로드
```

### 6-3. 로그인 버튼 클릭해도 main.jsp로 이동 안 됨 (DB 연결 실패)

**증상:**

- 로그인 버튼을 눌러도 main.jsp로 이동하지 않음
- 다른 사람들은 같은 소스로 정상 작동
- 로그에 `Cannot create JDBC driver of class '' for connect URL 'null'` 에러 발생

**원인:** 데이터베이스 연결 설정 파일 `Omok_Mini.xml`이 누락됨

**진단:**

```bash
# Context XML 파일 확인
ls -l ~/tomcat9/conf/Catalina/localhost/Omok_Mini.xml

# 로그에서 DB 연결 에러 확인
tail -100 ~/tomcat9/logs/catalina.out | grep -i "jdbc\|driver\|datasource"
```

**해결:**

```bash
# 백업 파일이 있는 경우 복사
cp ~/tomcat9/conf/Catalina/localhost/Omok_Mini.xml.BAK \
   ~/tomcat9/conf/Catalina/localhost/Omok_Mini.xml

# Tomcat 재시작
~/tomcat9/bin/shutdown.sh || true
sleep 2
~/tomcat9/bin/startup.sh
```

**백업 파일이 없는 경우:** 다른 팀원에게 `Omok_Mini.xml` 파일을 받거나, 아래 내용으로 생성:

```xml
<Context>
<Resource
    	name = "jdbc/omokdb"
    	auth = "Container"
    	type = "javax.sql.DataSource"
    	driverClassName = "org.mariadb.jdbc.Driver"
    	url = "jdbc:mariadb://[DB_HOST]:3306/omokdb?useSSL=false&amp;characterEncoding=UTF-8"
    	username = "[DB_USERNAME]"
    	password = "[DB_PASSWORD]"
    	maxTotal = "20"
    	maxIdle = "10"
    	maxWaitMillis = "1000"
    />
</Context>
```

### 6-4. Context XML 충돌

**증상:** 심링크 배포했는데 다른 설정이 적용됨

**원인:** `~/tomcat9/conf/Catalina/localhost/Omok_Mini.xml` 파일이 우선 적용됨

**진단:**

```bash
ls -l ~/tomcat9/conf/Catalina/localhost/Omok_Mini.xml
```

**해결:**

```bash
# 백업 후 제거
mv ~/tomcat9/conf/Catalina/localhost/Omok_Mini.xml \
   ~/tomcat9/conf/Catalina/localhost/Omok_Mini.xml.bak

# Tomcat 재시작
~/tomcat9/bin/shutdown.sh || true
sleep 2
~/tomcat9/bin/startup.sh
```

### 6-5. 포트 충돌 (8080/8005)

**증상:** Tomcat 시작 시 포트가 이미 사용 중

**진단:**

```bash
# 8080 포트 사용 프로세스 확인
lsof -i :8080

# 8005 포트 확인 (Tomcat shutdown 포트)
lsof -i :8005
```

**해결:**

```bash
# Tomcat이 이미 실행 중이면 종료
~/tomcat9/bin/shutdown.sh

# 종료되지 않으면 강제 종료
pkill -9 -f tomcat

# 또는 특정 PID 종료
# kill -9 [PID]
```

### 6-6. 빌드 후에도 변경사항이 반영되지 않음

**해결:**

```bash
# 1. 기존 클래스 파일 전체 삭제
rm -rf ~/workspace/test-dev/Omok_Mini/src/main/webapp/WEB-INF/classes/*

# 2. Tomcat 캐시 삭제
rm -rf ~/tomcat9/work/Catalina/localhost/Omok_Mini

# 3. 다시 빌드
cd ~/workspace/test-dev/Omok_Mini
./scripts/build.sh

# 4. Tomcat 재시작
~/tomcat9/bin/shutdown.sh || true
sleep 2
~/tomcat9/bin/startup.sh
```

### 6-7. 완전 초기화 (전체 재배포)

**모든 것을 처음부터 다시 시작:**

```bash
cd ~/workspace/test-dev/Omok_Mini

# 1. 컴파일 산출물 삭제
rm -rf src/main/webapp/WEB-INF/classes/*

# 2. 빌드
./scripts/build.sh

# 3. Tomcat 종료
~/tomcat9/bin/shutdown.sh || true
sleep 2

# 4. 기존 배포/캐시 전체 삭제
rm -rf ~/tomcat9/webapps/Omok_Mini
rm -rf ~/tomcat9/work/Catalina/localhost/Omok_Mini
rm -f ~/tomcat9/conf/Catalina/localhost/Omok_Mini.xml

# 5. 심링크 재배포
ln -s ~/workspace/test-dev/Omok_Mini/src/main/webapp ~/tomcat9/webapps/Omok_Mini

# 6. Tomcat 시작
~/tomcat9/bin/startup.sh

# 7. 로그 확인
tail -f ~/tomcat9/logs/catalina.out
```

---

## 7. 추가 팁

### 7-1. 빌드 경고 무시

```
warning: [options] source value 8 is obsolete and will be removed in a future release
warning: [options] target value 8 is obsolete and will be removed in a future release
```

**설명:** Java 8이 오래된 버전이라는 경고지만, 컴파일은 정상적으로 작동합니다. 무시해도 됩니다.

### 7-2. 빠른 개발 사이클

1. **코드 수정** (Java 또는 JSP)
2. **VSCode에서 Ctrl+Shift+B** (Java 파일 수정 시만)
3. **터미널에서 Tomcat 재시작**
   ```bash
   ~/tomcat9/bin/shutdown.sh || true && sleep 2 && ~/tomcat9/bin/startup.sh
   ```
4. **브라우저 새로고침**

### 7-3. Git 무시 파일

`.gitignore`에 다음 항목이 포함되어 있는지 확인:

```
src/main/webapp/WEB-INF/classes/
.vscode/
*.class
```

---

## 8. 참고 정보

### 8-1. Classpath 구성

빌드 시 사용되는 classpath:

1. `~/tomcat9/lib/servlet-api.jar`
2. `~/tomcat9/lib/websocket-api.jar`
3. `src/main/webapp/WEB-INF/lib/*.jar` (gson, mariadb, jstl, slf4j)

### 8-2. 컨트롤러 매핑 예시

주요 URL 패턴:

- `/sign/signIn` → 로그인 페이지
- `/sign/signUp` → 회원가입 페이지
- `/sign/logout` → 로그아웃
- `/lobby` → 로비
- `/rank` → 랭킹

### 8-3. WebSocket 엔드포인트

- `/game/{gameId}` → 게임 WebSocket
- `/room/{roomId}` → 방 WebSocket

---

## 문제 발생 시

1. **로그 확인:** `tail -f ~/tomcat9/logs/catalina.out`
2. **클래스 파일 삭제 후 재빌드**
3. **Tomcat 캐시 삭제**
4. **완전 초기화** (6-6 참고)

그래도 해결되지 않으면 위 트러블슈팅 섹션을 참고하세요.
